<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編集画面 - BloSke</title>
    
    <!-- アイコン設定 -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- 共通スタイル -->
    <link rel="stylesheet" href="common.css">

    <!-- Firebase SDK (common.js より先に読み込む) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- このページ専用のスタイル -->
    <style>
        /* (common.css で定義済み) */
    </style>
</head>
<body>

    <main>
        <div id="edit-container">
            <!-- プロジェクト名 (仕様書 3.2.2) -->
            <h2 id="project-title" class="project-title" title="クリックして編集">my project</h2>

            <!-- ボタンフィールド (仕様書 3.2.2) -->
            <div class="button-field">
                <button id="add-block-btn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> ブロック追加</button>
                <button id="edit-mode-btn" class="btn btn-secondary"><i class="fa-solid fa-pen"></i> 編集モード</button>
                <button id="toggle-view-btn" class="btn btn-secondary"><i class="fa-solid fa-arrows-left-right"></i> 縦横表示</button>
                <button id="save-btn" class="btn btn-secondary"><i class="fa-solid fa-save"></i> 保存</button>
                <button id="export-img-btn" class="btn btn-secondary"><i class="fa-solid fa-image"></i> 画像出力</button>
                <button id="reset-btn" class="btn btn-secondary" style="color: #dc3545;"><i class="fa-solid fa-trash"></i> リセット</button>
            </div>

            <!-- タイムテーブルフィールド (Canvas) (仕様書 3.2.2) -->
            <div id="timetable-canvas-container">
                <canvas id="timetableCanvas">
                    お使いのブラウザはCanvasに対応していません。
                </canvas>
            </div>
            
            <!-- オプション (仕様書 3.2.2) -->
            <div class="canvas-options">
                <input type="checkbox" id="two-column-toggle">
                <label for="two-column-toggle">2段組</label>
            </div>
        </div>
    </main>

    <!-- ブロック情報編集ウィンドウ (モーダル) (仕様書 3.2.2) -->
    <div id="block-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="block-modal-title" class="modal-title">ブロック情報</h2>
            <form id="block-edit-form">
                <input type="hidden" id="block-id"> <!-- 編集時に使用 -->
                
                <div class="form-group">
                    <label for="block-name">ブロック名</label>
                    <input type="text" id="block-name" class="form-input" required>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 2;">
                        <label for="block-start-date">開始日</label>
                        <input type="date" id="block-start-date" class="form-input" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="block-start-time">開始時刻</label>
                        <!-- ★★★ 修正 (問題2): step="300" を削除 ★★★ -->
                        <input type="time" id="block-start-time" class="form-input" required>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 2;">
                        <label for="block-end-date">終了日</label>
                        <input type="date" id="block-end-date" class="form-input" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="block-end-time">終了時刻</label>
                        <!-- ★★★ 修正 (問題2): step="300" を削除 ★★★ -->
                        <input type="time" id="block-end-time" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>カラー</label>
                    <div id="color-picker" style="display: flex; justify-content: space-around; padding: 10px 0;">
                        <!-- JSで動的に生成 -->
                    </div>
                    <input type="hidden" id="block-color" value="#3B82F6">
                </div>

                <div class="modal-actions">
                    <button type="button" id="cancel-block-edit-btn" class="btn btn-secondary">キャンセル</button>
                    <button type="submit" class="btn btn-primary">決定</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 共通スクリプト -->
    <script src="common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 共通UIを初期化
            initCommonUI('BloSke');

            const projectNameEl = document.getElementById('project-title');
            const canvasContainer = document.getElementById('timetable-canvas-container');
            const canvas = document.getElementById('timetableCanvas');
            const ctx = canvas.getContext('2d');

            // ★★★ 修正 (問題1): ブロックデータをグローバルに管理 ★★★
            let projectBlocks = [];
            let currentProjectName = '新規プロジェクト';

            // --- プロジェクト名設定 ---
            const urlParams = new URLSearchParams(window.location.search);
            const loadedCsvData = sessionStorage.getItem('bloske_loaded_csv');
            
            if (loadedCsvData) {
                // プロジェクト一覧から読み込まれた場合
                currentProjectName = sessionStorage.getItem('bloske_current_project_name') || '読み込みプロジェクト';
                // TODO: CSVデータをパースして projectBlocks に設定
                // projectBlocks = parseCsv(loadedCsvData); 
                sessionStorage.removeItem('bloske_loaded_csv'); 
                sessionStorage.removeItem('bloske_current_project_name');
            } else if (urlParams.has('restore')) {
                // ローカルストレージから復元する場合
                loadFromLocalStorage();
            } else {
                // 新規作成の場合
                currentProjectName = sessionStorage.getItem('bloske_current_project_name') || '新規プロジェクト';
                sessionStorage.removeItem('bloske_current_project_name');
            }
            projectNameEl.textContent = currentProjectName;

            // --- モーダル設定 ---
            setupModalClose('block-edit-modal', '#cancel-block-edit-btn');
            
            // カラーピッカー生成 (仕様書 3.2.2)
            const colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#64748B'];
            const colorPicker = document.getElementById('color-picker');
            const blockColorInput = document.getElementById('block-color');
            
            colors.forEach(color => {
                const colorCircle = document.createElement('div');
                colorCircle.style.width = '30px';
                colorCircle.style.height = '30px';
                colorCircle.style.borderRadius = '50%';
                colorCircle.style.backgroundColor = color;
                colorCircle.style.cursor = 'pointer';
                colorCircle.style.border = '3px solid transparent';
                colorCircle.dataset.color = color;
                
                if (color === blockColorInput.value) {
                    colorCircle.style.borderColor = '#333'; // 選択中
                }

                colorCircle.addEventListener('click', () => {
                    blockColorInput.value = color;
                    // 選択中のスタイルを更新
                    Array.from(colorPicker.children).forEach(child => {
                        child.style.borderColor = 'transparent';
                    });
                    colorCircle.style.borderColor = '#333';
                });
                colorPicker.appendChild(colorCircle);
            });

            // --- Canvas描画 ---
            function drawCanvas() {
                const width = canvasContainer.clientWidth;
                const height = 400; // TODO: 高さを動的に
                
                canvas.width = width;
                canvas.height = height;

                ctx.clearRect(0, 0, width, height);

                if (projectBlocks.length === 0) {
                    // 空表示 (仕様書 3.2.2)
                    ctx.fillStyle = '#adb5bd';
                    ctx.font = '16px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('イベントが1つも登録されていません。', width / 2, height / 2);
                    return;
                }

                // ★★★ 修正 (問題1): ブロックの簡易描画 (デバッグ用) ★★★
                // 本来は仕様書に基づき時間軸を描画
                ctx.fillStyle = '#333';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`ブロック数: ${projectBlocks.length} (Canvas描画は未実装です)`, 20, 40);

                projectBlocks.forEach((block, index) => {
                    ctx.fillStyle = block.color;
                    ctx.fillRect(20, 60 + (index * 40), 200, 30);
                    ctx.fillStyle = '#ffffff'; // テキスト色
                    ctx.font = '14px sans-serif';
                    ctx.fillText(block.name, 30, 80 + (index * 40));
                });
            }
            
            window.addEventListener('resize', drawCanvas);
            drawCanvas(); // 初期描画

            // --- ★★★ 修正 (問題1): ブロック追加ロジック ★★★
            document.getElementById('block-edit-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                // フォームから値を取得
                const name = document.getElementById('block-name').value;
                const startDate = document.getElementById('block-start-date').value;
                const startTime = document.getElementById('block-start-time').value;
                const endDate = document.getElementById('block-end-date').value;
                const endTime = document.getElementById('block-end-time').value;
                const color = document.getElementById('block-color').value;

                // バリデーション (簡易)
                if (!name || !startDate || !startTime || !endDate || !endTime) {
                    alert('すべての日時を入力してください。');
                    return;
                }

                // ISO文字列に変換 (仕様書 6.1 CSV形式)
                const startISO = new Date(`${startDate}T${startTime}`).toISOString();
                const endISO = new Date(`${endDate}T${endTime}`).toISOString();

                if (new Date(endISO) <= new Date(startISO)) {
                    alert('終了日時は開始日時より後に設定してください。');
                    return;
                }

                // ブロックオブジェクトを作成
                const newBlock = {
                    id: Date.now().toString(), // 簡易ID
                    name: name,
                    startISO: startISO,
                    endISO: endISO,
                    color: color
                };

                // TODO: 編集モードの場合は既存のブロックを更新
                
                // 配列に追加
                projectBlocks.push(newBlock);
                
                // ローカルストレージに保存 (仕様書 3.2.2)
                saveToLocalStorage();
                
                // Canvas再描画
                drawCanvas();
                
                // モーダルを閉じる
                hideModal('block-edit-modal');
            });


            // --- ボタンイベントリスナー ---
            
            // [ブロック追加]
            document.getElementById('add-block-btn').addEventListener('click', () => {
                document.getElementById('block-modal-title').textContent = 'ブロック追加';
                document.getElementById('block-edit-form').reset();
                document.getElementById('block-id').value = ''; // 新規モード
                
                // 日付/時刻のデフォルト値を設定 (現在)
                const now = new Date();
                const yyyyMMdd = now.toISOString().split('T')[0];
                const hhMM = now.toTimeString().substring(0, 5);
                document.getElementById('block-start-date').value = yyyyMMdd;
                document.getElementById('block-start-time').value = hhMM;
                document.getElementById('block-end-date').value = yyyyMMdd;
                document.getElementById('block-end-time').value = hhMM;

                // カラーピッカーの選択状態をリセット
                blockColorInput.value = colors[0];
                 Array.from(colorPicker.children).forEach((child, index) => {
                    child.style.borderColor = (index === 0) ? '#333' : 'transparent';
                });
                showModal('block-edit-modal');
            });

            // [保存] (仕様書 3.2.2)
            document.getElementById('save-btn').addEventListener('click', () => {
                const user = getUserSession();
                if (!user) {
                    // 未ログイン時
                    alert('プロジェクトを保存するにはログインが必要です。');
                    sessionStorage.setItem('login_redirect_reason', 'save');
                    window.location.href = 'login.html';
                    return;
                }

                // ログイン時
                saveProjectData(user.username);
            });

            async function saveProjectData(username) {
                const projectName = projectNameEl.textContent;
                
                // ★★★ 修正 (問題1): ブロックデータからCSVを生成 ★★★
                let csvData = "ブロック名,開始日時ISO,終了日時ISO,カラーコード\n"; // ヘッダー
                projectBlocks.forEach(block => {
                    csvData += `"${block.name}","${block.startISO}","${block.endISO}","${block.color}"\n`;
                });
                
                if (!confirm(`プロジェクト「${projectName}」を保存しますか？`)) {
                    return;
                }

                try {
                    await callGasApi('saveProject', {
                        username: username,
                        projectName: projectName,
                        csvData: csvData
                    });
                    alert('保存しました。');
                    // 保存に成功したらローカルストレージは不要
                    localStorage.removeItem('bloske_local_project');
                } catch (error) {
                    console.error('保存失敗:', error);
                }
            }

            // --- ローカルストレージ機能 ---
            function saveToLocalStorage() {
                const data = {
                    name: projectNameEl.textContent,
                    blocks: projectBlocks
                };
                localStorage.setItem('bloske_local_project', JSON.stringify(data));
            }
            
            function loadFromLocalStorage() {
                try {
                    const dataStr = localStorage.getItem('bloske_local_project');
                    if (!dataStr) return;
                    
                    const data = JSON.parse(dataStr);
                    projectNameEl.textContent = data.name || '復元プロジェクト';
                    projectBlocks = data.blocks || [];
                } catch (e) {
                    console.error('ローカルストレージの復元に失敗:', e);
                    localStorage.removeItem('bloske_local_project');
                }
            }

        });
    </script>
</body>
</html>
