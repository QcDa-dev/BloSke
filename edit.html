<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編集画面 - BloSke</title>
    
    <!-- アイコン設定 -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- 共通スタイル -->
    <link rel="stylesheet" href="common.css">
    
    <!-- このページ専用のスタイル -->
    <style>
        /* カレンダーピッカーやカラーピッカーのスタイルをここに追加（将来的に） */
/* ... existing code ... -->
        </div>
    </div>


    <!-- Firebase SDK (互換性バージョン) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- 共通スクリプト -->
    <script src="common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 共通UIの初期化
            initCommonUI('BloSke'); 

            const projectTitleEl = document.getElementById('project-title');
            const canvas = document.getElementById('timetableCanvas');
            const ctx = canvas.getContext('2d');
            
            // --- グローバル変数 ---
            let currentUser = null;
            let currentProjectName = '無題のプロジェクト';
            let blocks = []; // タイムテーブルのブロックデータ
            
            // --- Canvas描画 (空の状態) ---
            function drawEmptyCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.font = "1.2rem 'Noto Sans JP', sans-serif";
                ctx.fillStyle = "#adb5bd";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("イベントが1つも登録されていません。", canvas.width / 2, canvas.height / 2);
                ctx.restore();
            }

            /**
             * CSVデータをブロックの配列に変換 (簡易パース)
             * 仕様書 6.1 の形式を想定: ブロック名,開始日時ISO,終了日時ISO,カラーコード
             */
            function parseCsvToBlocks(csvData) {
                if (!csvData) return [];
                const parsedBlocks = [];
                const lines = csvData.split('\n');
                
                // 1行目 (ヘッダー) をスキップ
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = line.split(',');
                    if (parts.length >= 4) {
                        parsedBlocks.push({
                            name: parts[0],
                            start: parts[1], // ISO文字列
                            end: parts[2],   // ISO文字列
                            color: parts[3]
                        });
                    }
                }
                return parsedBlocks;
            }
            
            /**
             * ブロックデータをCSV文字列に変換
             */
            function convertBlocksToCsv(blocksArray) {
                let csv = "ブロック名,開始日時ISO,終了日時ISO,カラーコード\n"; // ヘッダー
                blocksArray.forEach(block => {
                    csv += `${block.name},${block.start},${block.end},${block.color}\n`;
                });
                return csv;
            }

            // --- プロジェクト読み込み ---
            function loadProject() {
                try {
                    const isNew = sessionStorage.getItem('bloSkeIsNewProject') === 'true';
                    const localData = localStorage.getItem('bloSkeDraft');
                    
                    if (isNew) {
                        // 新規作成
                        const projectName = sessionStorage.getItem('bloSkeCurrentProjectName') || '新規プロジェクト';
                        projectTitleEl.textContent = projectName;
                        currentProjectName = projectName; // 内部変数に保持
                        sessionStorage.removeItem('bloSkeIsNewProject'); // フラグ削除
                        localStorage.removeItem('bloSkeDraft'); // 古いドラフトを消す
                        blocks = []; // ブロックを初期化
                        drawEmptyCanvas();
                    } else if (localData) {
                        // ローカル保存からの復元
                        console.log('ローカルデータを復元します。');
                        const data = JSON.parse(localData);
                        projectTitleEl.textContent = data.projectName || '無題のプロジェクト';
                        currentProjectName = data.projectName || '無題のプロジェクト'; // 内部変数に保持
                        
                        // projects.htmlから読み込んだデータ形式 (JSON)
                        if (data.blocks) {
                            blocks = data.blocks;
                        } 
                        // edit.htmlで自動保存されたデータ形式 (CSV)
                        else if (data.csvData) { 
                            blocks = parseCsvToBlocks(data.csvData);
                        } 
                        else {
                            blocks = [];
                        }
                        
                        console.log('復元したブロック:', blocks);
                        
                        // TODO: blocks を使ってCanvasを描画するロジック
                        if (blocks.length === 0) {
                            drawEmptyCanvas();
                        } else {
                            // TODO: 描画関数呼び出し
                            drawEmptyCanvas(); // 仮
                        }
                    } else {
                        // ローカルデータなし (index.htmlから直接来たなど)
                        alert('プロジェクト情報が見つかりません。メイン画面に戻ります。');
                        window.location.href = 'index.html';
                        return;
                    }

                } catch (e) {
                    blocks = [];
                    drawEmptyCanvas();
                }
            }
            
            // --- 自動保存 (仕様書 3.2.1) ---
            function autoSaveToLocal() {
                try {
                    const csvData = convertBlocksToCsv(blocks);
                    const dataToSave = {
                        projectName: currentProjectName,
                        csvData: csvData // ローカル保存はCSV形式に統一
                    };
                    localStorage.setItem('bloSkeDraft', JSON.stringify(dataToSave));
                    console.log('ローカルに自動保存しました。');
                } catch (e) {
                    console.error('ローカルへの自動保存に失敗しました。', e);
                }
            }

            // --- 初期化 ---
            currentUser = getUserSession(); // ログイン状態を取得
            loadProject();
            
            // TODO: ブロックが変更されるたびに autoSaveToLocal() を呼び出す
            // (例: ブロック追加、編集、削除、ドラッグ＆ドロップ後)
            
            // --- モーダル設定 ---
            // ブロック追加モーダル
            document.getElementById('add-block-btn').addEventListener('click', () => {
                document.getElementById('block-modal-title').textContent = 'ブロック追加';
                // TODO: フォームをリセットする
                showModal('block-edit-modal');
            });
            setupModalClose('block-edit-modal', ['block-edit-cancel-btn']);
            
            // リセット確認モーダル
            document.getElementById('reset-btn').addEventListener('click', () => {
                showModal('reset-confirm-modal');
            });
            setupModalClose('reset-confirm-modal', ['reset-cancel-btn']);
            
            // --- ボタンイベントリスナー ---
            
            // プロジェクト名編集 (仕様書 3.2.2)
            projectTitleEl.addEventListener('click', () => {
                const newName = prompt('新しいプロジェクト名を入力してください:', currentProjectName);
                if (newName && newName.trim() !== '') {
                    currentProjectName = newName.trim();
                    projectTitleEl.textContent = currentProjectName;
                    autoSaveToLocal(); // 名前変更を自動保存
                }
            });

            // 保存 (仕様書 3.2.2 / 4.3)
            document.getElementById('save-btn').addEventListener('click', async () => {
                if (!currentUser) {
                    // 未ログイン時
                    alert('プロジェクトを保存するにはログインが必要です。\nログイン画面に移動します。');
                    // TODO: ログイン後、このページに戻って保存を再開するロジック (sessionStorageにフラグ)
                    sessionStorage.setItem('bloSkeRedirectToSave', 'true');
                    window.location.href = 'login.html';
                    return;
                }

                // ログイン時
                try {
                    const csvData = convertBlocksToCsv(blocks);
                    const data = await callGasApi('saveProject', {
                        username: currentUser.username,
                        projectName: currentProjectName,
                        csvData: csvData
                    });
                    alert(data.message || 'プロジェクトを保存しました。');
                    
                    // ローカルのドラフトは削除しても良い (サーバー保存が正となるため)
                    // localStorage.removeItem('bloSkeDraft'); 
                    
                } catch (error) {
                    console.error('プロジェクトの保存に失敗:', error);
                }
            });


            // TODO: 削除確認モーダル (編集モード時に動的に設定)
            // setupModalClose('delete-confirm-modal', ['delete-cancel-btn']);

            // --- 将来的なCanvasリサイズ対応 (参考) ---
            function resizeCanvas() {
                const container = document.getElementById('timetable-canvas-container');
                // コンテナの幅に合わせる (ただし、最小幅は確保)
                canvas.width = Math.max(container.clientWidth, 1000); 
                // 高さは固定またはコンテナに合わせる
                canvas.height = 400; 
                
                // 再描画
                // TODO: 実際の描画関数を呼ぶ
                if (blocks.length === 0) {
                    drawEmptyCanvas();
                } else {
                    // drawAllBlocks(); 
                    drawEmptyCanvas(); // 仮
                }
            }
            
            // ウィンドウリサイズ時にCanvasもリサイズ
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); // 初期描画
        });
    </script>
</body>
</html>
