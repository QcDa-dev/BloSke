<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保存データ一覧 - BloSke</title>
    
    <!-- アイコン設定 -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- 共通スタイル -->
    <link rel="stylesheet" href="common.css">

    <!-- Firebase SDKの読み込み (common.jsより前) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>

    <main>
        <div class="container">
            <h1>保存済みプロジェクト</h1>
            
            <!-- ユーザー情報 -->
            <div id="user-info" class="user-info-bar">
                <i class="fa-solid fa-user"></i>
                <span id="username-display">読み込み中...</span>
            </div>

            <!-- プロジェクト一覧 -->
            <div id="projects-list-container" class="projects-list">
                <!-- <div class="project-item">
                    <span>プロジェクト名</span>
                    <button class="btn btn-primary btn-sm"><i class="fa-solid fa-folder-open"></i> 読み込む</button>
                </div> -->
                <p id="loading-projects">プロジェクト一覧を読み込んでいます...</p>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button id="back-to-main-btn" class="btn btn-secondary">
                    <i class="fa-solid fa-arrow-left"></i> メイン画面に戻る
                </button>
            </div>
        </div>
    </main>

    <!-- 共通スクリプト -->
    <script src="common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 共通UIを初期化
            initCommonUI('BloSke');
            
            // 認証ガード (未ログインならlogin.htmlへ)
            const user = getUserSession();
            if (!user) {
                authGuard(); // (内部でlogin.htmlへリダイレクト)
                return;
            }

            const usernameDisplay = document.getElementById('username-display');
            const listContainer = document.getElementById('projects-list-container');
            const loadingMsg = document.getElementById('loading-projects');

            usernameDisplay.textContent = user.username; // ユーザー名を表示

            // --- プロジェクト一覧の読み込み (仕様書 4.3) ---
            async function loadProjects() {
                try {
                    const data = await callGasApi('listProjects', {
                        username: user.username
                    });
                    
                    loadingMsg.style.display = 'none'; // ローディング非表示

                    if (data.projects && data.projects.length > 0) {
                        data.projects.forEach(projectName => {
                            const item = document.createElement('div');
                            item.className = 'project-item';
                            item.innerHTML = `
                                <span>${escapeHTML(projectName)}</span>
                                <button class="btn btn-primary btn-sm" data-project-name="${escapeHTML(projectName)}">
                                    <i class="fa-solid fa-folder-open"></i> 読み込む
                                </button>
                            `;
                            listContainer.appendChild(item);
                        });
                    } else {
                        listContainer.innerHTML = '<p>保存されているプロジェクトはありません。</p>';
                    }

                } catch (error) {
                    loadingMsg.textContent = 'プロジェクト一覧の読み込みに失敗しました。';
                    loadingMsg.style.color = 'red';
                    console.error('プロジェクト一覧の読み込み失敗:', error);
                }
            }

            loadProjects();

            // --- プロジェクト読み込み処理 (仕様書 4.3) ---
            listContainer.addEventListener('click', async (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.projectName) {
                    const projectName = e.target.dataset.projectName;
                    
                    if (!confirm(`「${projectName}」を読み込みますか？\n（現在編集中の内容は失われます）`)) {
                        return;
                    }

                    try {
                        const data = await callGasApi('loadProject', {
                            username: user.username,
                            projectName: projectName
                        });
                        
                        // 読み込んだCSVデータをセッションストレージに保存
                        sessionStorage.setItem('bloske_loaded_csv', data.csvData);
                        sessionStorage.setItem('bloske_current_project_name', projectName);
                        
                        // 編集画面に遷移
                        window.location.href = 'edit.html';

                    } catch (error) {
                         console.error('プロジェクトの読み込み失敗:', error);
                    }
                }
            });

            // メイン画面に戻る
            document.getElementById('back-to-main-btn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            function escapeHTML(str) {
                return str.replace(/[&<>"']/g, function(match) {
                    return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                    }[match];
                });
            }
        });
    </script>
</body>
</html>
